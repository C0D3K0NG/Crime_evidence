generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String                 @id @default(uuid())
  username          String                 @unique
  email             String                 @unique
  fullName          String
  badgeNumber       String?
  department        String?
  role              String
  passwordHash      String
  mfaEnabled        Boolean                @default(false)
  isActive          Boolean                @default(true)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  accessLogs        AccessLog[]
  custodyEventsTo   CustodyEvent[]         @relation("ToUser")
  custodyEventsFrom CustodyEvent[]         @relation("FromUser")
  custodiedEvidence Evidence[]             @relation("CurrentCustodian")
  collectedEvidence Evidence[]             @relation("CollectedBy")
  createdBoxes      CrimeBox[]             @relation("BoxCreator")
  createdCases      Case[]                 @relation("CaseCreator")
  comments          EvidenceComment[]
  accessRequests    EvidenceAccessRequest[] @relation("Requester")
  reviewedRequests  EvidenceAccessRequest[] @relation("Reviewer")
  labResults        LabResult[]
  notifications      Notification[]
  activityLogs      ActivityLog[]
}

model Case {
  id          String     @id @default(uuid())
  title       String
  description String?
  status      String     @default("open")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  createdById String
  createdBy   User       @relation("CaseCreator", fields: [createdById], references: [id])
  crimeBoxes  CrimeBox[]
}

model CrimeBox {
  id          String   @id @default(uuid())
  name        String
  caseId      String   @unique
  privateKey  String   @unique
  publicKey   String   @unique
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation("BoxCreator", fields: [createdById], references: [id])
  caseRef     Case?    @relation(fields: [caseRefId], references: [id])
  caseRefId   String?
}

model Evidence {
  id                 String                  @id @default(uuid())
  caseId             String
  type               String
  description        String
  collectionDate     DateTime
  location           String
  tags               String?
  fileHash           String?
  ipfsCid            String?
  status             String
  locked             Boolean                 @default(false)
  officerNotes       String?
  retentionDeadline  DateTime?
  retentionPolicy    String?
  allowedRoles       String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  collectedById      String
  currentCustodianId String
  accessLogs         AccessLog[]
  custodyEvents      CustodyEvent[]
  currentCustodian   User                    @relation("CurrentCustodian", fields: [currentCustodianId], references: [id])
  collectedBy        User                    @relation("CollectedBy", fields: [collectedById], references: [id])
  files              EvidenceFile[]
  comments           EvidenceComment[]
  accessRequests     EvidenceAccessRequest[]
  labResults         LabResult[]
}

model CustodyEvent {
  id         String   @id @default(uuid())
  eventType  String
  reason     String
  status     String
  signature  String?
  timestamp  DateTime @default(now())
  evidenceId String
  fromUserId String
  toUserId   String
  toUser     User     @relation("ToUser", fields: [toUserId], references: [id])
  fromUser   User     @relation("FromUser", fields: [fromUserId], references: [id])
  evidence   Evidence @relation(fields: [evidenceId], references: [id])
}

model AccessLog {
  id         String   @id @default(uuid())
  action     String
  ipAddress  String?
  userAgent  String?
  result     String
  timestamp  DateTime @default(now())
  evidenceId String
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  evidence   Evidence @relation(fields: [evidenceId], references: [id])
}

model EvidenceFile {
  id         String   @id @default(uuid())
  fileName   String
  fileSize   Int
  mimeType   String
  sha256Hash String
  ipfsCid    String?
  uploadedAt DateTime @default(now())
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id])
}

model EvidenceComment {
  id         String   @id @default(uuid())
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  evidenceId String
  userId     String
  evidence   Evidence @relation(fields: [evidenceId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model EvidenceAccessRequest {
  id          String    @id @default(uuid())
  reason      String
  status      String    @default("pending")
  reviewNotes String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  evidenceId  String
  requesterId String
  reviewerId  String?
  evidence    Evidence  @relation(fields: [evidenceId], references: [id])
  requester   User      @relation("Requester", fields: [requesterId], references: [id])
  reviewer    User?     @relation("Reviewer", fields: [reviewerId], references: [id])
}

model LabResult {
  id            String   @id @default(uuid())
  title         String
  summary       String
  findings      String?
  fileUrl       String?
  submittedAt   DateTime @default(now())
  evidenceId    String
  submittedById String
  evidence      Evidence @relation(fields: [evidenceId], references: [id])
  submittedBy   User     @relation(fields: [submittedById], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model ActivityLog {
  id          String   @id @default(uuid())
  actorId     String
  actorName   String
  action      String
  entityType  String
  entityId    String
  entityLabel String?
  createdAt   DateTime @default(now())
  actor       User     @relation(fields: [actorId], references: [id])
}
